drop table if exists game CASCADE;
drop table if exists import CASCADE;
drop table if exists performance CASCADE;
drop table if exists athlete CASCADE;
drop table if exists regions CASCADE; 
drop table if exists event CASCADE; 
drop table if exists tables CASCADE; 

--\! java transformer athlete_events.csv rendu.csv
\! iconv -f iso-8859-1 -t utf-8 athlete_events.csv > athlete.csv 
CREATE temp TABLE import (
n1 integer, n2 varchar(150), n3 varchar(1), n4 varchar(2), n5 varchar(3) , n6 text, n7 text, n8 varchar(3), n9 varchar(12), n10 int,n11 varchar(6),n12 text, n13 varchar(50), n14 text, n15 text);


\echo 'Création de la table import...'
\copy import FROM athlete.csv with (FORMAT CSV, DELIMITER ',', HEADER)


DELETE from import where n10<1920;
DELETE from import where n13='Art Competitions';

\! echo Nombre de lignes après la restriction demandée
SELECT count(*) from import;

--------------------------------------------------------------------------------------

\! iconv -f iso-8859-1 -t utf-8 noc_regions.csv > regions.csv 
CREATE TABLE regions (
n1 varchar(3), n2 varchar(50), n3 varchar(50),
Constraint PK_regions PRIMARY KEY (n1)
);

\echo 'Création de la table regions...'
\copy regions FROM regions.csv with (FORMAT CSV, DELIMITER ',')
\! echo

--------------------------------------------------------------------------------------

CREATE TABLE event (
    ID serial,
    n13 text, 
    n14 text,
    Constraint PK_events PRIMARY KEY (ID)
);

create table athlete (
    ID serial, 
    Name varchar(150), 
    Sex varchar(1), 
    Team varchar(100),
    Constraint PK_athlete PRIMARY KEY(ID)
    );

CREATE TABLE game (
    ID serial, 
    game text, 
    YEAR int, 
    season text, 
    city text,
    Constraint PK_game PRIMARY KEY(ID)
    ) ;

CREATE TABLE performance(
    id_athlete int REFERENCES athlete(ID),
    id_event int REFERENCES event(ID),
    id_game int REFERENCES game(ID),
    noc text REFERENCES regions(n1),
    medal text, age int ,weight float ,height int,
    Constraint pk_performance PRIMARY KEY(id_athlete, id_event, id_game, noc)
    ) ;

Insert into event(n13, n14)
    select DISTINCT n13, n14 from import;

Insert into athlete(
    select distinct n1, n2, n3 from import
);

Insert into game(game, YEAR, season, city)
    select distinct n9, n10, n11, n12 from import;

create temp table tables(name text);
    insert into tables
        values ('game'), ('athlete'), ('performance'), ('event'), ('import'), ('regions');

    select sum(pg_total_relation_size(quote_ident(name))) as total_size_bytes
    from tables;

\copy (select sum(pg_total_relation_size(quote_ident(name))) as total_size_bytes from tables) to 'toto.txt';